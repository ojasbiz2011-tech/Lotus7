<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess SaaS Arena</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --primary: #2563eb;
            --text-main: #0f172a;
        }

        body {
            font-family: 'Consolas', monospace;
            background: linear-gradient(135deg, #e0e7ff 0%, #f1f5f9 100%);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow);
            width: 100%;
            max-width: 420px;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        h1 { font-size: 28px; margin-bottom: 10px; color: #1e3a8a; }
        h2 { font-size: 20px; margin-bottom: 20px; }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            margin-top: 10px;
        }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }

        .input-field {
            width: 90%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-family: inherit;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        /* Lobby List */
        .lobby-container {
            background: rgba(255,255,255,0.6);
            border-radius: 12px;
            margin: 20px 0;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .lobby-item {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 14px;
        }
        .lobby-item:last-child { border-bottom: none; }
        
        /* Game Screen */
        #board { margin: 20px auto; width: 100%; }
        .status-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="screen-login" class="glass-panel screen active">
        <h1>Monetize your<br>Chess Skills üí∞</h1>
        <p style="color: #64748b; margin-bottom: 30px;">Enter your Telegram handle to join the pro league.</p>
        <input type="text" id="username" class="input-field" placeholder="@username">
        <button class="btn" onclick="joinLobby()">Enter Tournament</button>
    </div>

    <div id="screen-lobby" class="glass-panel screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Lobby #8492</h2>
            <span style="font-size:12px; color:green;">‚óè Live</span>
        </div>
        
        <div class="lobby-container" id="lobby-list">
            </div>
        
        <div id="lobby-status" style="font-size: 13px; color: #64748b; margin-bottom: 15px;">
            Waiting for players...
        </div>

        <button class="btn" id="pay-btn" onclick="goToPayment()">Join Prize Pool (‚Çπ10)</button>
    </div>

    <div id="screen-payment" class="glass-panel screen">
        <h2>Secure Entry</h2>
        <div style="background:#f1f5f9; padding:20px; border-radius:12px; margin-bottom:20px;">
            <div style="font-size:32px; font-weight:bold; color:#0f172a;">‚Çπ10.00</div>
            <div style="font-size:12px; color:#64748b;">Tournament Entry Fee</div>
        </div>
        <input type="text" class="input-field" placeholder="UPI ID (e.g. 98765@ybl)">
        <button class="btn" onclick="processPayment()">Pay & Find Match</button>
        <button class="btn" style="background:transparent; color:#64748b; border:1px solid #cbd5e1;" onclick="showScreen('screen-lobby')">Cancel</button>
    </div>

    <div id="screen-searching" class="glass-panel screen">
        <h2>Finding Opponent...</h2>
        <div class="spinner" style="margin: 40px 0; font-size: 40px;">üîç</div>
        <p>Waiting for another player to pay the entry fee...</p>
        <p style="font-size:12px; color:#64748b;">Do not close this window.</p>
    </div>

    <div id="screen-game" class="glass-panel screen">
        <div class="status-badge" id="game-status">Opponent's Turn</div>
        <div id="board" style="width: 320px"></div>
        <div style="display:flex; justify-content:space-between; font-size:14px; margin-top:10px;">
            <span id="player-white" style="font-weight:bold;">‚ö™ White</span>
            <span id="player-black" style="font-weight:bold;">‚ö´ Black</span>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const LOBBY_KEY = 'chess_lobby_v1';
        const MATCH_KEY = 'chess_match_queue_v1';
        const GAME_KEY = 'chess_active_game_v1';
        
        let myUser = '';
        let myColor = 'w';
        let game = null;
        let board = null;
        let gameInterval = null;

        // --- NAVIGATION ---
        function showScreen(id) {
            $('.screen').removeClass('active');
            $('#' + id).addClass('active');
        }

        // --- STEP 1: JOIN LOBBY ---
        function joinLobby() {
            const user = $('#username').val().trim();
            if(!user) return alert("Enter a username!");
            myUser = user;
            
            // Add to LocalStorage "Server"
            let lobby = JSON.parse(localStorage.getItem(LOBBY_KEY) || '[]');
            
            // Prevent duplicate joins
            if(!lobby.find(u => u.name === myUser)) {
                lobby.push({ name: myUser, status: 'idle', joinedAt: Date.now() });
                localStorage.setItem(LOBBY_KEY, JSON.stringify(lobby));
            }

            showScreen('screen-lobby');
            refreshLobby();
            setInterval(refreshLobby, 2000); // Poll every 2s
        }

        // --- STEP 2: LOBBY LOGIC ---
        function refreshLobby() {
            // Read from "Server"
            const lobby = JSON.parse(localStorage.getItem(LOBBY_KEY) || '[]');
            const list = $('#lobby-list');
            list.empty();

            if(lobby.length === 0) {
                list.append('<div style="padding:20px; color:#94a3b8;">Lobby is empty.</div>');
            } else {
                lobby.forEach(u => {
                    const isMe = u.name === myUser ? '(You)' : '';
                    const style = u.name === myUser ? 'font-weight:bold; color:var(--primary);' : '';
                    list.append(`
                        <div class="lobby-item" style="${style}">
                            <span>${u.name} ${isMe}</span>
                            <span>${u.status === 'playing' ? '‚öîÔ∏è In Game' : 'üü¢ Online'}</span>
                        </div>
                    `);
                });
            }
            $('#lobby-status').text(`${lobby.length} players online.`);
        }

        function goToPayment() {
            showScreen('screen-payment');
        }

        // --- STEP 3: MATCHMAKING ---
        function processPayment() {
            // 1. Mark user as "Searching"
            showScreen('screen-searching');
            
            // Check Queue
            let queue = JSON.parse(localStorage.getItem(MATCH_KEY) || '[]');
            
            // Remove self if already there (cleanup)
            queue = queue.filter(u => u.name !== myUser);
            
            if (queue.length > 0) {
                // FOUND A MATCH!
                const opponent = queue.pop(); // Take one person out
                localStorage.setItem(MATCH_KEY, JSON.stringify(queue)); // Update queue
                
                // Initialize Game
                const gameData = {
                    id: Date.now(),
                    white: opponent.name,
                    black: myUser,
                    fen: 'start',
                    lastMove: null
                };
                localStorage.setItem(GAME_KEY, JSON.stringify(gameData));
                
                startGame(gameData, 'b'); // I am Black
            } else {
                // NO MATCH, WAIT IN QUEUE
                queue.push({ name: myUser, time: Date.now() });
                localStorage.setItem(MATCH_KEY, JSON.stringify(queue));
                
                // Poll for game start
                const checkGameInterval = setInterval(() => {
                    const activeGame = JSON.parse(localStorage.getItem(GAME_KEY));
                    if(activeGame && (activeGame.white === myUser || activeGame.black === myUser)) {
                        clearInterval(checkGameInterval);
                        startGame(activeGame, activeGame.white === myUser ? 'w' : 'b');
                    }
                }, 1000);
            }
        }

        // --- STEP 4: GAME LOGIC ---
        function startGame(gameData, color) {
            myColor = color;
            showScreen('screen-game');
            
            // Update UI Names
            $('#player-white').text(`‚ö™ ${gameData.white} ${color==='w'?'(You)':''}`);
            $('#player-black').text(`‚ö´ ${gameData.black} ${color==='b'?'(You)':''}`);

            // Init Chess Engine
            game = new Chess();
            
            // Init Board with FIXED PIECES URL
            board = Chessboard('board', {
                draggable: true,
                position: 'start',
                orientation: color === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png', // FIX APPLIED
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            });

            // Start Syncing
            gameInterval = setInterval(syncGame, 500);
        }

        // --- CHESS RULES & SYNC ---
        function onDragStart (source, piece) {
            // Stop if game over or not my turn
            if (game.game_over()) return false;
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
            if ((game.turn() === 'w' && myColor !== 'w') || 
                (game.turn() === 'b' && myColor !== 'b')) return false;
        }

        function onDrop (source, target) {
            // Attempt Move
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            // Push Move to "Server"
            const activeGame = JSON.parse(localStorage.getItem(GAME_KEY));
            activeGame.fen = game.fen();
            activeGame.lastMove = { from: source, to: target };
            localStorage.setItem(GAME_KEY, JSON.stringify(activeGame));
            
            updateStatus();
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        function syncGame() {
            const serverGame = JSON.parse(localStorage.getItem(GAME_KEY));
            if(!serverGame) return;

            // If FEN on server is different from local, update local
            if (serverGame.fen !== game.fen()) {
                game.load(serverGame.fen);
                board.position(serverGame.fen);
                updateStatus();
            }
        }

        function updateStatus() {
            let status = '';
            let moveColor = game.turn() === 'b' ? 'Black' : 'White';

            if (game.in_checkmate()) {
                status = 'Game over! ' + moveColor + ' is in checkmate.';
            } else if (game.in_draw()) {
                status = 'Game drawn.';
            } else {
                status = moveColor + "'s Turn";
                if (game.in_check()) status += ' (Check!)';
            }
            $('#game-status').text(status);
        }

        // Responsive Fix
        $(window).resize(() => { if(board) board.resize(); });
    </script>
</body>
</html>
